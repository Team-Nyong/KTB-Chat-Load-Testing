name: Setup Backend Servers

on:
  workflow_dispatch:
    inputs:
      environment:
        description: '배포 환경'
        required: true
        default: 'develop'
        type: choice
        options:
          - develop
          - production

env:
  DEPLOY_PATH: /home/ubuntu/chat-be
  SSH_USER: ubuntu

jobs:
  # 먼저 서버 목록을 파싱
  prepare:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Debug SERVER_IPS format
        run: |
          VALUE='${{ secrets.SERVER_IPS }}'
          echo "Length: ${#VALUE}"
          echo "First char: ${VALUE:0:1}"
          echo "Second char: ${VALUE:1:1}"
          echo "Last char: ${VALUE: -1}"
          # JSON 유효성 검사
          echo "$VALUE" | python3 -c "import sys,json; json.load(sys.stdin)" && echo "Valid JSON" || echo "Invalid JSON"

      - id: set-matrix
        run: |
          echo "matrix=${{ secrets.SERVER_IPS }}" >> $GITHUB_OUTPUT

  setup:
    needs: prepare
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        server: ${{ fromJson(needs.prepare.outputs.matrix) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ matrix.server }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Check & Install Docker
        run: |
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 ${{ env.SSH_USER }}@${{ matrix.server }} << 'ENDSSH'
          echo "=== Checking Docker on $(hostname) - ${{ matrix.server }} ==="

          if command -v docker &> /dev/null; then
            echo "Docker already installed: $(docker --version)"
          else
            echo "Installing Docker..."
            sudo apt-get update
            sudo apt-get install -y ca-certificates curl gnupg
            sudo install -m 0755 -d /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            sudo chmod a+r /etc/apt/keyrings/docker.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
            sudo apt-get update
            sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
            sudo usermod -aG docker $USER
            echo "Docker installed: $(docker --version)"
          fi

          # Verify docker-compose
          if docker compose version &> /dev/null; then
            echo "Docker Compose: $(docker compose version)"
          else
            echo "ERROR: Docker Compose not available"
            exit 1
          fi
          ENDSSH

      - name: Create Deploy Directory
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ matrix.server }} "mkdir -p ${{ env.DEPLOY_PATH }}"

      - name: Copy docker-compose-be.yaml
        run: |
          scp -o StrictHostKeyChecking=no docker-compose-be.yaml ${{ env.SSH_USER }}@${{ matrix.server }}:${{ env.DEPLOY_PATH }}/

      - name: Create .env.be file
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ matrix.server }} "cat > ${{ env.DEPLOY_PATH }}/.env.be << 'EOF'
          ${{ secrets.DOT_ENV_BE }}
          EOF"
          echo "Created .env.be on ${{ matrix.server }}"

      - name: Verify Setup
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ matrix.server }} << ENDSSH
          echo "=== Setup Complete for ${{ matrix.server }} ==="
          echo "Files in ${{ env.DEPLOY_PATH }}:"
          ls -la ${{ env.DEPLOY_PATH }}
          echo ""
          docker --version
          docker compose version
          ENDSSH
